---
title: Stripe 플러그인
label: Stripe
order: 110
desc: Stripe로 쉽게 결제를 받으세요
keywords: 플러그인, stripe, 결제, 전자상거래
---

![https://www.npmjs.com/package/@payloadcms/plugin-stripe](https://img.shields.io/npm/v/@payloadcms/plugin-stripe)

이 플러그인을 사용하면 [Stripe](https://stripe.com)를 Payload에 쉽게 통합할 수 있습니다. Stripe 자격 증명만 제공하면 이 플러그인이 두 플랫폼 간의 양방향 통신 채널을 열어줍니다. 이를 통해 데이터를 쉽게 동기화하고 Payload의 [액세스 제어](../access-control/overview)를 통해 Stripe REST API를 프록시할 수 있습니다. 이 플러그인을 사용하여 청구를 완전히 Stripe에 오프로드하면서 애플리케이션 데이터에 대한 완전한 제어권을 유지하세요.

예를 들어, 일회성 결제나 구독이 필요한 `products` 또는 `plans` 컬렉션이 있는 전자상거래 또는 SaaS 애플리케이션을 구축하는 경우가 있습니다. 이러한 각 제품을 Stripe에 연결한 다음 청구 관련 이벤트를 쉽게 구독하여 활성 구매나 구독 취소와 같은 애플리케이션의 비즈니스 로직을 수행할 수 있습니다.

프론트엔드에서 결제 플로우를 구축하려면 [Stripe Checkout](https://stripe.com/payments/checkout)을 사용하거나 [Stripe Web Elements](https://stripe.com/docs/payments/elements)를 사용하여 처음부터 완전히 커스텀 결제 경험을 구축할 수도 있습니다. 그런 다음 완전히 커스텀하고 안전한 고객 대시보드를 구축하려면 Payload의 액세스 제어를 활용하여 Stripe 리소스에 대한 액세스를 제한할 수 있으므로 사용자가 계정 관리를 위해 사이트를 떠날 필요가 없습니다.

이 플러그인의 아름다운 점은 애플리케이션의 콘텐츠와 비즈니스 로직 전체를 Payload에서 처리할 수 있고 Stripe는 청구와 결제 처리만 담당한다는 것입니다. 사용자가 소유하는 API와 데이터베이스에서 끝없이 커스터마이징하고 확장할 수 있는 완전히 독점적인 애플리케이션을 구축할 수 있습니다. Shopify나 BigCommerce와 같은 호스팅 서비스는 애플리케이션의 콘텐츠를 분산시킨 다음 액세스에 대해 비용을 청구할 수 있습니다.

<Banner type="info">
  이 플러그인은 완전히 오픈소스이며 [소스 코드는
  여기에서](https://github.com/payloadcms/payload/tree/main/packages/plugin-stripe)
  찾을 수 있습니다. 도움이 필요하시면 [커뮤니티
  도움말](https://payloadcms.com/community-help)을 확인하세요. 버그를 발견했다고 생각되면
  가능한 한 자세한 내용과 함께 [새 이슈를
  열어주세요](https://github.com/payloadcms/payload/issues/new?assignees=&labels=plugin%3A%20stripe&template=bug_report.md&title=plugin-stripe%3A).
</Banner>

## 핵심 기능

- SaaS 애플리케이션 배송 시 Stripe 자격 증명을 숨김
- [Payload 액세스 제어](https://payloadcms.com/docs/access-control/overview)를 통한 제한된 키 허용
- Stripe와 Payload 간의 양방향 통신 채널 활성화
- [Stripe REST API](https://stripe.com/docs/api) 프록시
- [Stripe 웹훅](https://stripe.com/docs/webhooks) 프록시
- 두 플랫폼 간의 데이터 자동 동기화

## 설치

[pnpm](https://pnpm.io), [npm](https://npmjs.com), [Yarn](https://yarnpkg.com)과 같은 JavaScript 패키지 관리자를 사용하여 플러그인을 설치하세요:

```bash
  pnpm add @payloadcms/plugin-stripe
```

## 기본 사용법

[Payload Config](https://payloadcms.com/docs/configuration/overview)의 `plugins` 배열에서 [옵션](#options)과 함께 플러그인을 호출하세요:

```ts
import { buildConfig } from 'payload'
import { stripePlugin } from '@payloadcms/plugin-stripe'

const config = buildConfig({
  plugins: [
    stripePlugin({
      stripeSecretKey: process.env.STRIPE_SECRET_KEY,
    }),
  ],
})

export default config
```

### 옵션

| 옵션                           | 타입               | 기본값      | 설명                                                                                    |
| ------------------------------ | ------------------ | ----------- | --------------------------------------------------------------------------------------- |
| `stripeSecretKey` \*           | string             | `undefined` | Stripe 비밀 키                                                                          |
| `stripeWebhooksEndpointSecret` | string             | `undefined` | Stripe 웹훅 엔드포인트 비밀                                                            |
| `rest`                         | boolean            | `false`     | `true`일 때 `/api/stripe/rest` 엔드포인트를 엽니다                                      |
| `webhooks`                     | object or function | `undefined` | 모든 웹훅 이벤트를 처리하는 함수이거나 이벤트 이름을 키로 하는 Stripe 웹훅 핸들러 객체 |
| `sync`                         | array              | `undefined` | 동기화 구성의 배열                                                                      |
| `logs`                         | boolean            | `false`     | `true`일 때 동기화 이벤트를 콘솔에 로그로 출력합니다                                    |

_\* 별표는 필수 속성을 나타냅니다._

## 엔드포인트

다음 커스텀 엔드포인트가 자동으로 열립니다:

| 엔드포인트             | 메서드 | 설명                                                                                                                                                                                                                        |
| ---------------------- | ------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `/api/stripe/rest`     | `POST` | [Payload 액세스 제어](https://payloadcms.com/docs/access-control/overview) 뒤에서 [Stripe REST API](https://stripe.com/docs/api)를 프록시하고 결과를 반환합니다. 자세한 내용은 [REST 프록시](#stripe-rest-proxy) 섹션을 참조하세요. |
| `/api/stripe/webhooks` | `POST` | 모든 Stripe 웹훅 이벤트를 처리합니다                                                                                                                                                                                        |

##### Stripe REST 프록시

`rest`가 true이면 [Payload 액세스 제어](https://payloadcms.com/docs/access-control/overview) 뒤에서 [Stripe REST API](https://stripe.com/docs/api)를 프록시하고 결과를 반환합니다. 이 플래그는 로컬 개발에서만 사용해야 하며, 자세한 정보는 아래 보안 주의사항을 참조하세요.

```ts
const res = await fetch(`/api/stripe/rest`, {
  method: 'POST',
  credentials: 'include',
  headers: {
    'Content-Type': 'application/json',
    // Authorization: `JWT ${token}` // 참고: 브라우저가 아닌 경우(즉, curl 또는 Postman) 이렇게 하세요
  },
  body: JSON.stringify({
    stripeMethod: 'stripe.subscriptions.list',
    stripeArgs: [
      {
        customer: 'abc',
      },
    ],
  }),
})
```

서버 측에서 API를 프록시해야 하는 경우 [stripeProxy](#node) 함수를 사용하세요.

<Banner type="info">
  **참고:**

이러한 라우트의 `/api` 부분은 Payload 구성에 정의된 설정에 따라 다를 수 있습니다.

</Banner>

<Banner type="warning">
  **경고:**

프로덕션에서 REST 프록시 엔드포인트를 여는 것은 잠재적인 보안 위험입니다. 인증된 사용자는 Stripe REST API에 열린 액세스 권한을 갖게 됩니다. 프로덕션에서는 자체 엔드포인트를 열고 [stripeProxy](#node) 함수를 사용하여 서버 측에서 Stripe API를 프록시하세요.

</Banner>

## 웹훅

[Stripe 웹훅](https://stripe.com/docs/webhooks)은 Stripe에서 Payload로 동기화하는 데 사용됩니다. 웹훅은 Stripe 계정의 이벤트를 수신하여 이에 대한 반응을 트리거할 수 있습니다. 웹훅을 활성화하려면 아래 단계를 따르세요.

개발:

1. Stripe CLI를 사용하여 로그인 `stripe login`
1. 이벤트를 로컬호스트로 전달 `stripe listen --forward-to localhost:3000/api/stripe/webhooks`
1. 주어진 비밀을 `.env` 파일에 `STRIPE_WEBHOOKS_ENDPOINT_SECRET`로 붙여넣기

프로덕션:

1. 로그인하고 Stripe 대시보드에서 [새 웹훅 생성](https://dashboard.stripe.com/test/webhooks/create)
1. `YOUR_DOMAIN_NAME/api/stripe/webhooks`를 "웹훅 엔드포인트 URL"로 붙여넣기
1. 브로드캐스트할 이벤트 선택
1. 주어진 비밀을 `.env` 파일에 `STRIPE_WEBHOOKS_ENDPOINT_SECRET`로 붙여넣기
1. 그런 다음 이 플러그인 구성의 `webhooks` 부분을 사용하여 이러한 이벤트를 처리하세요:

```ts
import { buildConfig } from 'payload'
import stripePlugin from '@payloadcms/plugin-stripe'

const config = buildConfig({
  plugins: [
    stripePlugin({
      stripeSecretKey: process.env.STRIPE_SECRET_KEY,
      stripeWebhooksEndpointSecret: process.env.STRIPE_WEBHOOKS_ENDPOINT_SECRET,
      webhooks: {
        'customer.subscription.updated': ({ event, stripe, stripeConfig }) => {
          // 무언가 실행...
        },
      },
      // 참고: 모든 Stripe 웹훅 이벤트를 캐치하고 이벤트 유형을 직접 처리할 수도 있습니다
      // webhooks: (event, stripe, stripeConfig) => {
      //   switch (event.type): {
      //     case 'customer.subscription.updated': {
      //       // 무언가 실행...
      //       break;
      //     }
      //     default: {
      //       break;
      //     }
      //   }
      // }
    }),
  ],
})

export default config
```

사용 가능한 웹훅의 전체 목록은 [여기](https://stripe.com/docs/cli/trigger#trigger-event)를 참조하세요.

## Node

서버에서는 [stripe](https://www.npmjs.com/package/stripe) npm 모듈을 사용하여 Stripe와 직접 인터페이스해야 합니다. 다음과 같이 보일 수 있습니다:

```ts
import Stripe from 'stripe'

const stripeSecretKey = process.env.STRIPE_SECRET_KEY
const stripe = new Stripe(stripeSecretKey, {
  apiVersion: '2022-08-01',
})

export const MyFunction = async () => {
  try {
    const customer = await stripe.customers.create({
      email: data.email,
    })

    // 무언가 실행...
  } catch (error) {
    console.error(error.message)
  }
}
```

또는 `/api/stripe/rest` 엔드포인트가 내부적으로 수행하는 것과 정확히 동일한 `stripeProxy`를 사용하여 Stripe와 인터페이스할 수 있습니다. 다음은 위와 동일한 예제이지만 프록시를 통해 파이프된 것입니다:

```ts
import { stripeProxy } from '@payloadcms/plugin-stripe'

export const MyFunction = async () => {
  try {
    const customer = await stripeProxy({
      stripeSecretKey: process.env.STRIPE_SECRET_KEY,
      stripeMethod: 'customers.create',
      stripeArgs: [
        {
          email: data.email,
        },
      ],
    })

    if (customer.status === 200) {
      // 무언가 실행...
    }

    if (customer.status >= 400) {
      throw new Error(customer.message)
    }
  } catch (error) {
    console.error(error.message)
  }
}
```

## 동기화

이 옵션은 Payload 컬렉션과 Stripe 리소스 간의 기본 동기화를 자동으로 설정합니다. 필요한 모든 훅과 웹훅 핸들러를 생성하므로 Payload 필드를 해당 Stripe 속성에 매핑하기만 하면 됩니다. Stripe 또는 Payload에서 문서가 생성, 업데이트 및 삭제되면 변경 사항이 양쪽에 반영됩니다.

<Banner type="info">
  **참고:**

_양방향_ 동기화를 활성화하려면 [`webhooks`](#webhooks)을 설정하고
구성을 통해 `stripeWebhooksEndpointSecret`을 전달해야 합니다.

</Banner>

```ts
import { buildConfig } from 'payload'
import stripePlugin from '@payloadcms/plugin-stripe'

const config = buildConfig({
  plugins: [
    stripePlugin({
      stripeSecretKey: process.env.STRIPE_SECRET_KEY,
      stripeWebhooksEndpointSecret: process.env.STRIPE_WEBHOOKS_ENDPOINT_SECRET,
      sync: [
        {
          collection: 'customers',
          stripeResourceType: 'customers',
          stripeResourceTypeSingular: 'customer',
          fields: [
            {
              fieldPath: 'name', // 자체 Payload Config의 필드
              stripeProperty: 'name', // 해당하는 경우 점 표기법 사용
            },
          ],
        },
      ],
    }),
  ],
})

export default config
```

<Banner type="warning">
  **참고:**

Stripe API의 제한으로 인해 현재는 최상위 필드에서만 작동합니다. 모든 Stripe 객체가
별도의 엔티티이기 때문에 간단한 재사용 가능한 라이브러리로 추상화하기 어렵기 때문입니다.
앞으로 이에 대한 패턴을 찾을 수도 있습니다. 하지만 지금은 그러한 경우를 하드코딩해야 합니다.

</Banner>

`sync`를 사용하면 다음이 수행됩니다:

- 각 컬렉션에 `stripeID` 읽기 전용 필드를 추가하고 유지합니다. 이는 _Stripe에서 생성된_ 필드이며 상호 참조로 사용됩니다
- Stripe.com의 리소스에 대한 직접 링크를 추가합니다
- 훅이 웹훅을 트리거할 때 무한 동기화를 방지하기 위해 각 컬렉션에 `skipSync` 읽기 전용 플래그를 추가하고 유지합니다
- 각 컬렉션에 다음 훅을 추가합니다:
  - `beforeValidate`: `createNewInStripe`
  - `beforeChange`: `syncExistingWithStripe`
  - `afterDelete`: `deleteFromStripe`
- 다음 Stripe 웹훅을 처리합니다
  - `STRIPE_TYPE.created`: `handleCreatedOrUpdated`
  - `STRIPE_TYPE.updated`: `handleCreatedOrUpdated`
  - `STRIPE_TYPE.deleted`: `handleDeleted`

## TypeScript

모든 타입은 직접 가져올 수 있습니다:

```ts
import {
  StripeConfig,
  StripeWebhookHandler,
  StripeProxy,
  ...
} from '@payloadcms/plugin-stripe/types';
```